varnishtest "'pipe_timeout' parameter"

server s1 {
	rxreq
	expect req.http.Upgrade == "websocket"
	txresp -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -body "Resp 1 -- 543210\n"

	delay 18
	sema r1 sync 2
} -start

varnish v1 -arg {-p pipe_timeout=15} -vcl+backend {
	sub vcl_recv {
		if (req.http.Upgrade ~ "(?i)websocket") {
			return (pipe);
		}
	}

	sub vcl_pipe {
		if (req.http.upgrade ~ "(?i)websocket") {
			set bereq.http.Upgrade = req.http.upgrade;
		}
	}
} -start

client c1 {
	txreq -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -body "Client 1 -- 012345\n"
	rxresp

	sema r1 sync 2
} -start


client c1 -wait
server s1 -wait

varnish v1 -expect sc_pipe_tmo == 1
