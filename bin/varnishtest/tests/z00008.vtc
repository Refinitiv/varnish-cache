varnishtest "'pipe_thread_max' parameter"

server s1 {
	rxreq
	expect req.http.Upgrade == "websocket"
	txresp -status 101 -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -body "Resp 1 -- 1\n"
	sema r1 sync 6
} -start

server s2 {
	rxreq
	expect req.http.upgrade == "websocket"
	txresp -status 101 -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -body "Resp 2 -- 22\n"
	sema r1 sync 6
} -start

varnish v1 -arg "-p pipe_thread_max=2" -vcl+backend {
	sub vcl_recv {
		if (req.http.server ~ "s1") {
			set req.backend_hint = s1;
		} else {
			set req.backend_hint = s2;
		}
		if (req.http.Upgrade ~ "(?i)websocket") {
			return (pipe);
		}
	}

	sub vcl_pipe {
		if (req.http.upgrade ~ "(?i)websocket") {
			set bereq.http.Upgrade = req.http.upgrade;
		}
	}
} -start

client c1 {
	txreq -url /foo -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -hdr "Server: s1" -body "Client 1 -- 9\n"
	rxresp
	expect resp.status == 101

	txreq -body "Client 1 -- 12345\n"

	sema r1 sync 6
} -start

client c2 {
	delay 3
	txreq -url /bar -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -hdr "Server: s2" -body "Client 2 -- 88\n"
	rxresp
	expect resp.status == 101

	txreq -body "Client 2 -- 56789\n"

	sema r1 sync 6
} -start

client c3 {
	delay 5
	txreq -url /bar2 -hdr "Connection: Upgrade" -hdr "Upgrade: websocket" -hdr "Server: s2" -body "Client 3 -- 999\n"
	delay 2

	sema r1 sync 6
} -start

delay 1
varnish v1 -expect n_pipe == 1

delay 4
varnish v1 -expect n_pipe == 2
sema r1 sync 6

varnish v1 -expect s_pipe == 3
varnish v1 -expect sc_tx_pipe == 2
varnish v1 -expect sc_pipe_drop == 1
varnish v1 -expect n_pipe_drop == 1
